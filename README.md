## Web Based Audio Recording

Record audio from a web browser and label them in Brain Imaging Data Structure (BIDS)

Converts .webm, .ogg, and all other formats to .mp3 and saves the mp3 file to the server at /app/data/audio and to the user's host machine. 

This app is comprised of two docker containers, and tested to work with Azure Container Instances, although any host with a storage volume to mount to the container should work.

# Configuration
In the storage volume that you mount, you will need to have the following folders and files:

/config
/ssl
/audio
/uploads

/config
-- studyOptions.json - data file containing options you want to appear in the study drop-down menu, and the short code for it (recommended 4 letters)

-- sessionOptions.json - same as studyOptions but for varying types of sessions. Could be left blank to result in a session label of just the number (but is helpful for tracking data to be paired with MRI sessions vs EEG or purely psycometric task days)

-- taskOptions.json - similar format but includes nested possibilities for different versions and acquisition types specific to each task. See example config folder.

-- serverOptions.json - definition of the FQDN for your server container (generated by your cloud provider). This is to be mounted in the client container, where the other config files get served by the server after the client knows where to point. You could mount one file volume to both client and server containers, but it's better to have this in a separate volume to create isolation between the server and client. The steps for this are the same, but you simply provide different credentials for a different volume share, and use the same directory structure for each.

/ssl
*.key
*.crt

-- certificate and private key files for TLS/SSL authentication (HTTPS is required for handling PHI, satisfying browser security requirements using the microphone from the web browser, and is just good practice). The easiest and cheapest way to do this is to register a domain, purchase an SSL certificate, and make a CNAME record in the DNS settings of your domain provider pointing to the fully qualified domain name (FQDN) generated by your cloud provider. For azure, this would be <your-client-dns-name>.<region>.azurecontainer.io 
Example: my-labs-audio-app-client.eastus.azurecontainer.io

-- these files are consumed by NGINX on the client side, and by the filesystem in the server container. They are not ever passed between client and server. It would be even better to use two different sets of certificates for the client and server.

/audio
-- this folder will be empty when you first deploy the application, but is where audio data will be stored after it is converted.

/uploads
-- intermediary folder for files moving between server and client. It will also be empty on deployment.

# Deployment
This application is designed to be configured for self-deployment without having to rebuild the app or any docker images (although the code here allows you to do so if you wish). 

To deploy, provide the docker image when you create your cloud container instance and mount the required folders defined above to /app/data of each container.

You can use the included bash script for launching the Azure Container Instances to Azure Cloud, and copy commands from az_tools.sh for creating your volume file share and uploading the files (assuming you have the AZ CLI installed and authenticated with an account).

You must provide a .env file to define all of the environment variables in the bash script. An Azure Subscription key, resource group, and all of the necessary azure resources are prerequisites. Setting up cloud services is beyond the scope of these instructions--there are many tutorials for doing this, or you can ask ChatGPT to walk you through it.

Make sure you run `source .env` to make all of the variables available in your shell environment before running the az commands. 

# Help setting up
If you are a researcher and would like help using this app, you may email me (Jack) at john.gray@mssm.edu or message me on github (or open an issue if you think there is a problem or improvement that would help others). You must credit the NARC Lab at Mount Sinai School of Medicine if used to collect published data. 


# Upcoming improvements

Terraform deployment
Audio quality options
